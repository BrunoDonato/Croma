{% extends "base.html" %}

{% block content %}
<main class="main-content with-sidebar os-page">

  <!-- Detalhes -->
  <section class="os-card os-detalhes">
    <div class="os-header">
      <h1>Detalhes da OS #{{ os.id }}</h1>
      {% if is_admin %}
  <a class="btn-small" href="{% url 'viagens:viagem_nova' %}?os={{ os.id }}">
    + Registrar viagem desta OS
  </a>
{% endif %}
      </a>
    </div>

    <div class="os-summary">
      <p><strong>Descrição do Problema:</strong> {{ os.descricao_texto|default:"—" }}</p>
      <p><strong>Loja:</strong> {{ os.loja }}</p>
      <p><strong>Solicitante:</strong> {{ os.solicitante.username }}</p>
      <p><strong>Status:</strong> {{ os.get_status_display|default:os.status }}</p>
      <p><strong>Prioridade:</strong> {{ os.get_prioridade_display|default:os.prioridade }}</p>
      <p><strong>Data de Abertura:</strong> {{ os.data_abertura|date:"d/m/Y H:i" }}</p>

      {% if os.data_fechamento %}
        <p><strong>Data de Fechamento:</strong> {{ os.data_fechamento|date:"d/m/Y H:i" }}</p>
      {% endif %}
      {% if os.tecnico_responsavel %}
        <p><strong>Técnico Responsável:</strong> {{ os.tecnico_responsavel.username }}</p>
      {% endif %}
      {% if os.observacoes %}
        <p><strong>Observações:</strong> {{ os.observacoes }}</p>
      {% endif %}
      {% if os.solucao %}
        <p><strong>Solução:</strong> {{ os.solucao }}</p>
      {% endif %}
      {% if os.motivo_cancelamento %}
        <p><strong>Motivo do Cancelamento:</strong> {{ os.motivo_cancelamento }}</p>
      {% endif %}
    </div>
  </section>

  <!-- Andamentos -->
<section class="os-card os-andamentos">
  <h3>Andamentos</h3>

  <form action="{% url 'ordens:os_comentario' os.id %}" method="post" class="stack mb-2">
    {% csrf_token %}
    <div class="field">
      {{ andamento_form.texto.label_tag }}
      {{ andamento_form.texto }}
    </div>

    {% if is_admin %}
      <div class="field">
        {{ andamento_form.visibilidade.label_tag }}
        {{ andamento_form.visibilidade }}
      </div>
    {% else %}
      <input type="hidden" name="visibilidade" value="PUBLICO">
    {% endif %}

    <button class="btn-small">Adicionar comentário</button>
  </form>

  <ul class="timeline">
    {% for a in andamentos %}
      <li class="tl-item">
        <div class="tl-meta">
          <strong>{{ a.autor.username }}</strong>
          <span>{{ a.criado_em|date:"d/m/Y H:i" }}</span>
        </div>
        {% if a.status_de or a.status_para %}
          <div class="muted">Status: {{ a.status_de|default:"—" }} → {{ a.status_para|default:"—" }}</div>
        {% endif %}
        <div>{{ a.texto|default:"(sem texto)" }}</div>
        <span class="badge">{{ a.get_visibilidade_display }}</span>
      </li>
    {% empty %}
      <li class="muted">Nenhum andamento registrado.</li>
    {% endfor %}
  </ul>
</section>


  <!-- Ações -->
{% if is_admin %}
  <aside class="os-card os-acoes">
    <h3>Ações</h3>

    <form action="{% url 'ordens:os_atribuir' os.id %}" method="post" class="stack">
      {% csrf_token %}
      {{ atribuir_form.as_p }}
      <button type="submit" class="btn-small w-full">Salvar atribuição/prioridade</button>
    </form>
    <hr>

    {% if os.status == "ABERTA" %}
      <form action="{% url 'ordens:os_acao_status' os.id %}" method="post" class="stack">
        {% csrf_token %}
        <input type="hidden" name="acao" value="EM_ANALISE">
        <button class="btn-small w-full">Iniciar Análise</button>
      </form>
      <form action="{% url 'ordens:os_acao_status' os.id %}" method="post" class="stack mt-2">
        {% csrf_token %}
        <input type="hidden" name="acao" value="CANCELADA">
        {{ cancelar_form.as_p }}
        <button class="btn-small btn-danger w-full">Cancelar OS</button>
      </form>

    {% elif os.status == "EM_ANALISE" %}
      <form action="{% url 'ordens:os_acao_status' os.id %}" method="post" class="stack">
        {% csrf_token %}
        <input type="hidden" name="acao" value="EM_EXECUCAO">
        <button class="btn-small w-full">Iniciar Execução</button>
      </form>
      <form action="{% url 'ordens:os_acao_status' os.id %}" method="post" class="stack mt-2">
        {% csrf_token %}
        <input type="hidden" name="acao" value="CANCELADA">
        {{ cancelar_form.as_p }}
        <button class="btn-small btn-danger w-full">Cancelar OS</button>
      </form>

    {% elif os.status == "EM_EXECUCAO" %}
      <form action="{% url 'ordens:os_acao_status' os.id %}" method="post" class="stack mb-2">
        {% csrf_token %}
        <input type="hidden" name="acao" value="FINALIZADA">
        {{ finalizar_form.as_p }}
        <button class="btn-small btn-success w-full">Finalizar OS</button>
      </form>
      <form action="{% url 'ordens:os_acao_status' os.id %}" method="post" class="stack">
        {% csrf_token %}
        <input type="hidden" name="acao" value="CANCELADA">
        {{ cancelar_form.as_p }}
        <button class="btn-small btn-danger w-full">Cancelar OS</button>
      </form>
    {% endif %}
  </aside>
{% endif %}


  <!-- Enviar Anexo -->
  <section class="os-card os-anexos">
    <h3>Enviar Anexo</h3>

    <form action="{% url 'ordens:os_anexo' os.id %}" method="post" enctype="multipart/form-data" class="stack mb-2">
      {% csrf_token %}
      {{ anexo_form.as_p }}
      <button class="btn-small">Enviar anexo</button>
    </form>

    <h4 class="mt-2">Anexos</h4>
    <ul class="attachments">
      {% for ax in os.anexos.all %}
        <li>
          <a href="{{ ax.arquivo.url }}" target="_blank">{{ ax.arquivo.name }}</a>
          <span class="muted"> • {{ ax.enviado_por.username }} — {{ ax.enviado_em|date:"d/m/Y H:i" }}</span>
        </li>
      {% empty %}
        <li class="muted">Nenhum anexo enviado.</li>
      {% endfor %}
    </ul>

    <hr>
    <a href="{% url 'ordens:os_listar' %}" class="btn-small">← Voltar à lista</a>
  </section>

</main>
{% endblock %}
